---
import Base from "../layouts/Layout.astro";
import fs from 'fs';
import yaml from 'js-yaml';

// Load YAML
const ateliers = yaml.load(fs.readFileSync('./src/content/ateliers.yaml', 'utf8'));

// Helpers
const frDate = new Intl.DateTimeFormat("fr-FR", { dateStyle: "long" });

function formatDate(dateStr) {
  return frDate.format(new Date(dateStr));
}

function sameDay(d1, d2) {
  return (
    d1.getFullYear() === d2.getFullYear() &&
    d1.getMonth() === d2.getMonth() &&
    d1.getDate() === d2.getDate()
  );
}

// Flatten all events and keep only those with href="/colleges"
// Also sort by end date (toDate) descending and prevent duplicates
const collegesEvents = Object.values(ateliers)
  .flat()
  .filter(event => event.href === "/colleges")
  .map(event => {
    const fromDate = new Date(event.from);
    const toDate = event.to ? new Date(event.to) : fromDate;

    let displayDate;
    if (sameDay(fromDate, toDate)) {
      displayDate = formatDate(fromDate);
    } else {
      displayDate = `${formatDate(fromDate)} → ${formatDate(toDate)}`;
    }

    return {
      ...event,
      fromDate,
      toDate,
      displayDate,
      uniqueKey: event.from + event.titre + event.lieu, // for duplicate prevention
    };
  })
  // Remove duplicates
  .filter((event, index, self) =>
    index === self.findIndex(e => e.uniqueKey === event.uniqueKey)
  )
  // Sort descending by toDate
  .sort((a, b) => b.toDate - a.toDate);
---

<Base title="Ateliers pour collèges">
  <main class="mx-auto max-w-[735px] mt-14">
    <h1 class="text-3xl font-bold mb-6">
      Ateliers de calligraphie pour collèges : horaires, tarifs et organisation
    </h1>

    <h2 class="text-2xl font-semibold mb-4">
      Mes formats d'atelier pour les collèges
    </h2>

    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-300 divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left font-medium text-gray-700">Horaires</th>
            <th class="px-4 py-2 text-left font-medium text-gray-700">Temps scolaire</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr>
            <td class="px-4 py-2">Durée</td>
            <td class="px-4 py-2">2 à 3 heures</td>
          </tr>
          <tr class="bg-gray-50">
            <td class="px-4 py-2">Nombre de participants</td>
            <td class="px-4 py-2">25 élèves maximum</td>
          </tr>
          <tr>
            <td class="px-4 py-2">Tarifs</td>
            <td class="px-4 py-2">60 euros HT par heure</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h2 class="text-2xl font-semibold mb-4 mt-8">
      Interventions passées
    </h2>

    <ul class="mt-6 space-y-4">
      {collegesEvents.map(event => (
        <li key={event.uniqueKey} class="border-b pb-2">
          <strong>{event.displayDate}</strong> — {event.titre}
          <br />
          <em>{event.lieu}</em>
          <br />
          {event.details}
        </li>
      ))}
    </ul>
  </main>
</Base>
